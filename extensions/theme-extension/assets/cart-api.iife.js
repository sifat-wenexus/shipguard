var CartAPI=function(d){"use strict";var f=Object.defineProperty;var w=(d,a,o)=>a in d?f(d,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):d[a]=o;var p=(d,a,o)=>(w(d,typeof a!="symbol"?a+"":a,o),o);const u=class u extends XMLHttpRequest{static addEventListener(e,t,n=!0){n?this.beforeListeners[e].add(t):this.afterListeners[e].add(t)}static removeEventListener(e,t,n=!0){n?this.beforeListeners[e].delete(t):this.afterListeners[e].delete(t)}open(e,t,n=!0,r,s){for(const i of u.beforeListeners.open)i(this,e,t,n,r,s);super.open(e,t,n,r,s);for(const i of u.afterListeners.open)i(this,e,t,n,r,s)}};p(u,"beforeListeners",{open:new Set}),p(u,"afterListeners",{open:new Set});let a=u;const h=class h{constructor(e){p(this,"listeners",new Set);p(this,"cart",null);if(this.fetchFn=e,!h.instance)h.instance=this;else return h.instance;window.fetch=async(t,n)=>{const r=typeof t=="string"||t instanceof URL?t.toString():t.url,s=this.getCartEndpoint(r);if(s){const i=await e(t,n);return await this.notifyListeners(s),i}return e(t,n)},window.XMLHttpRequest=a,a.addEventListener("open",(t,n,r)=>{const s=this.getCartEndpoint(r);s&&t.addEventListener("load",async()=>this.notifyListeners(s))},!0)}getCartEndpoint(e){const t=typeof e=="string"?e:e.toString(),n=new URL(!t.startsWith("http://")||!t.startsWith("https://")?`${window.location.origin}/${t}`:t),r={add:"/cart/add",update:"/cart/update",change:"/cart/change",clear:"/cart/clear"};for(const s in r){const i=r[s];if([i,`${i}.js`].some(c=>n.pathname.endsWith(c)))return s}return null}async notifyListeners(e){const t=this.cart,n=await this.get(!0);if(JSON.stringify(t,null,0)===JSON.stringify(n,null,0))return t;for(const r of this.listeners)r(n,{requestType:e,updatedBy:"api"});return n}addListener(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}removeListener(e){this.listeners.delete(e)}async request(e,t,n=!0){const r=await this.fetchFn.call(window,`/cart/${e}.js`,{method:"POST",headers:t?{"Content-Type":"application/json"}:void 0,body:t?JSON.stringify(t):void 0});return n?{cart:await this.notifyListeners(e),response:await r.json()}:{cart:await this.get(!n),response:await r.json()}}async get(e=!1){if(this.cart&&!e)return this.cart;const n=await(await fetch("/cart.js")).json();return this.cart=n,n}async update(e,t=!0){const{cart:n}=await this.request("update",{updates:e},t);return n}async append(e,t=!0){const{cart:n}=await this.request("add",{items:e},t);return n}async prepend(e,t=!0){const n=await this.get(),r=e.concat(Array.from(n.items).reverse().map(s=>{var i;return{id:s.variant_id,quantity:s.quantity,selling_plan:(i=s.selling_plan)==null?void 0:i.id,properties:s.properties}}));return this.replace(r,t)}async change(e,t=!0){const{cart:n}=await this.request("change",e,t);return n}async remove(e,t=!0){const n=e.filter(s=>{var i;return(i=this.cart)==null?void 0:i.items.some(c=>c.variant_id===s)});if(!n.length)return await this.get();const{cart:r}=await this.request("update",{updates:n.reduce((s,i)=>({...s,[i]:0}),{})},t);return r}async move(e,t,n=!0){const r=await this.get(),s=r.items.find(c=>c.variant_id===e);if(!s)return r;const i=r.items.filter(c=>c.variant_id!==e);return i.splice(t,0,s),this.replace(i.map(c=>{var l;return{id:c.variant_id,quantity:c.quantity,selling_plan:(l=c.selling_plan)==null?void 0:l.id,properties:c.properties}}),n)}async replace(e,t=!0){return await this.clear(!1),this.append(e,t)}async clear(e=!0){const{cart:t}=await this.request("clear",void 0,e);return t}};p(h,"instance");let o=h;return window.weNexusCartApi=new o(fetch),d.CartApi=o,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}),d}({});
