var d=function(a){"use strict";var g=Object.defineProperty;var y=(d,a,o)=>a in d?g(d,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):d[a]=o;var c=(d,a,o)=>(y(d,typeof a!="symbol"?a+"":a,o),o);(function(){const f=class f extends XMLHttpRequest{static addEventListener(s,e,t=!0){t?this.beforeListeners[s].add(e):this.afterListeners[s].add(e)}static removeEventListener(s,e,t=!0){t?this.beforeListeners[s].delete(e):this.afterListeners[s].delete(e)}open(s,e,t=!0,r,n){for(const i of f.beforeListeners.open)i(this,s,e,t,r,n);super.open(s,e,t,r,n);for(const i of f.afterListeners.open)i(this,s,e,t,r,n)}};c(f,"beforeListeners",{open:new Set}),c(f,"afterListeners",{open:new Set});let o=f;const h=class h{constructor(s){c(this,"queue",new Set);c(this,"listeners",{before:new Set,after:new Set});c(this,"running",null);c(this,"cart",null);if(this.fetchFn=s,!h.instance)h.instance=this;else return h.instance;window.fetch=async(t,r)=>{const n=typeof t=="string"||t instanceof URL?t.toString():t.url,i=this.getCartEndpoint(n);if(i){const u=s(t,r);this.notifyListeners(i,u);const l=await u;return await this.notifyListeners(i),l}return s(t,r)},window.XMLHttpRequest=o,o.addEventListener("open",(t,r,n)=>{const i=this.getCartEndpoint(n);if(i){const u=new Promise((l,p)=>{t.addEventListener("load",()=>{l(void 0),this.notifyListeners(i)}),t.addEventListener("error",p)});this.notifyListeners(i,u)}},!0);const e=localStorage.getItem("wenexus-cart-queue");e&&(this.queue=new Set(JSON.parse(e))),this.runQueue(this.queue.size>0),window.addEventListener("beforeunload",t=>{if(this.queue.size>0)return t.preventDefault(),"Cart updates are still in progress. Are you sure you want to leave?"})}getCartEndpoint(s){const e=typeof s=="string"?s:s.toString(),t=new URL(!e.startsWith("http://")||!e.startsWith("https://")?`${window.location.origin}/${e}`:e),r={add:"/cart/add",update:"/cart/update",change:"/cart/change",clear:"/cart/clear"};for(const n in r){const i=r[n];if([i,`${i}.js`].some(u=>t.pathname.endsWith(u)))return n}return null}async notifyListeners(s,e){const t=this.cart;if(e){for(const i of this.listeners.before)i(t??await this.get(!0),{requestType:s,updatedBy:"api"},()=>new Promise(u=>{const l=()=>{if(this.queue.size>0||this.running)return setTimeout(l,800);u(e.then(()=>this.get(!0)))};setTimeout(l,800)}));await e;const n=await this.get(!0);return JSON.stringify(t,null,0)===JSON.stringify(n,null,0)?t:n}const r=await this.get(!0);if(JSON.stringify(t,null,0)===JSON.stringify(r,null,0))return t;for(const n of this.listeners.after)n(r,{requestType:s,updatedBy:"api"});return r}addListener(s,e=!1){return this.listeners[e?"before":"after"].add(s),()=>{this.removeListener(s,e)}}removeListener(s,e=!1){this.listeners[e?"before":"after"].delete(s)}async runQueue(s=!1){if(!this.running){for(const e of this.queue){this.running=e,this.queue.delete(e),localStorage.setItem("wenexus-cart-queue",JSON.stringify(Array.from(this.queue)));const t=await this.fetchFn.call(window,`/cart/${e.type}.js`,{method:"POST",headers:e.payload?{"Content-Type":"application/json"}:void 0,body:e.payload?JSON.stringify(e.payload):void 0});window.dispatchEvent(new CustomEvent(`wenexus-cart-response-${e.id}`,{detail:t}))}this.running=null,s&&(alert("Recovered from lost cart updates"),this.notifyListeners("add")),this.queue.size>0&&setTimeout(()=>this.runQueue(),10)}}waitForResponse(s){return new Promise(e=>{window.addEventListener(`wenexus-cart-response-${s}`,t=>e(t.detail))})}async request(s,e,t=!0){const r=Math.random().toString(36).slice(2)+Date.now().toString(36);this.queue.add({id:r,type:s,payload:e,trigger:t}),localStorage.setItem("wenexus-cart-queue",JSON.stringify(Array.from(this.queue))),this.runQueue();const n=await this.waitForResponse(r);return t?{cart:await this.notifyListeners(s),response:await n.json()}:{cart:await this.get(!t),response:await n.json()}}async get(s=!1){if(this.cart&&!s)return this.cart;const t=await(await fetch("/cart.js")).json();return this.cart=t,t}async update(s,e=!0){const{cart:t}=await this.request("update",{updates:s},e);return t}async append(s,e=!0){const{cart:t}=await this.request("add",{items:s},e);return t}async remove(s,e=!0){const t=s.filter(n=>{var i;return(i=this.cart)==null?void 0:i.items.some(u=>u.variant_id===n)});if(!t.length)return await this.get();const{cart:r}=await this.request("update",{updates:t.reduce((n,i)=>({...n,[i]:0}),{})},e);return r}};c(h,"instance");let w=h;return window.weNexusCartApi=new w(fetch),a.CartApi=w,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"}),a}({})})();
