var CartAPI=function(c){"use strict";var g=Object.defineProperty;var y=(c,o,u)=>o in c?g(c,o,{enumerable:!0,configurable:!0,writable:!0,value:u}):c[o]=u;var d=(c,o,u)=>(y(c,typeof o!="symbol"?o+"":o,u),u);const h=class h extends XMLHttpRequest{static addEventListener(t,e,s=!0){s?this.beforeListeners[t].add(e):this.afterListeners[t].add(e)}static removeEventListener(t,e,s=!0){s?this.beforeListeners[t].delete(e):this.afterListeners[t].delete(e)}open(t,e,s=!0,n,r){for(const i of h.beforeListeners.open)i(this,t,e,s,n,r);super.open(t,e,s,n,r);for(const i of h.afterListeners.open)i(this,t,e,s,n,r)}};d(h,"beforeListeners",{open:new Set}),d(h,"afterListeners",{open:new Set});let o=h;const l=class l{constructor(t){d(this,"queue",new Set);d(this,"listeners",{before:new Set,after:new Set});d(this,"running",null);d(this,"cart",null);if(this.fetchFn=t,!l.instance)l.instance=this;else return l.instance;const e=async(n,r)=>{const i=typeof n=="string"||n instanceof URL?n.toString():n.url,a=this.getCartEndpoint(i);if(a){const f=t(n,r);this.notifyListeners(a,f);const w=await f;return await this.notifyListeners(a),w}return t(n,r)};window.fetch=e,window.XMLHttpRequest=o,o.addEventListener("open",(n,r,i)=>{const a=this.getCartEndpoint(i);if(a){const f=new Promise((w,p)=>{n.addEventListener("load",()=>{w(void 0),this.notifyListeners(a)}),n.addEventListener("error",p)});this.notifyListeners(a,f)}},!0);const s=localStorage.getItem("wenexus-cart-queue");s&&(this.queue=new Set(JSON.parse(s))),this.runQueue(this.queue.size>0),window.addEventListener("beforeunload",n=>{if(this.queue.size>0)return n.preventDefault(),"Cart updates are still in progress. Are you sure you want to leave?"})}addListener(t,e=!1){return this.listeners[e?"before":"after"].add(t),()=>{this.removeListener(t,e)}}removeListener(t,e=!1){this.listeners[e?"before":"after"].delete(t)}async get(t=!1){if(this.cart&&!t)return this.cart;const s=await(await fetch("/cart.js")).json();return this.cart=s,s}async update(t,e=!0){const{cart:s}=await this.request("update",{updates:t},e);return s}async append(t,e=!0){const{cart:s}=await this.request("add",{items:t},e);return s}async remove(t,e=!0){const s=t.filter(r=>{var i;return(i=this.cart)==null?void 0:i.items.some(a=>a.variant_id===r)});if(!s.length)return await this.get();const{cart:n}=await this.request("update",{updates:s.reduce((r,i)=>({...r,[i]:0}),{})},e);return n}getCartEndpoint(t){const e=typeof t=="string"?t:t.toString(),s=new URL(!e.startsWith("http://")||!e.startsWith("https://")?`${window.location.origin}/${e}`:e),n={add:"/cart/add",update:"/cart/update",change:"/cart/change",clear:"/cart/clear"};for(const r in n){const i=n[r];if([i,`${i}.js`].some(a=>s.pathname.endsWith(a)))return r}return null}async notifyListeners(t,e){const s=this.cart;if(e){for(const i of this.listeners.before)i(s??await this.get(!0),{requestType:t,updatedBy:"api"},()=>new Promise(a=>{const f=()=>{if(this.queue.size>0||this.running)return setTimeout(f,800);a(e.then(()=>this.get(!0)))};setTimeout(f,800)}));await e;const r=await this.get(!0);return JSON.stringify(s,null,0)===JSON.stringify(r,null,0)?s:r}const n=await this.get(!0);if(JSON.stringify(s,null,0)===JSON.stringify(n,null,0))return s;for(const r of this.listeners.after)r(n,{requestType:t,updatedBy:"api"});return n}async runQueue(t=!1){if(!this.running){for(const e of this.queue){this.running=e,this.queue.delete(e),localStorage.setItem("wenexus-cart-queue",JSON.stringify(Array.from(this.queue)));const s=await this.fetchFn.call(window,`/cart/${e.type}.js`,{method:"POST",headers:e.payload?{"Content-Type":"application/json"}:void 0,body:e.payload?JSON.stringify(e.payload):void 0});window.dispatchEvent(new CustomEvent(`wenexus-cart-response-${e.id}`,{detail:s}))}this.running=null,t&&(alert("Recovered from lost cart updates"),this.notifyListeners("add")),this.queue.size>0&&setTimeout(()=>this.runQueue(),10)}}waitForResponse(t){return new Promise(e=>{window.addEventListener(`wenexus-cart-response-${t}`,s=>e(s.detail))})}async request(t,e,s=!0){const n=Math.random().toString(36).slice(2)+Date.now().toString(36);this.queue.add({id:n,type:t,payload:e,trigger:s}),localStorage.setItem("wenexus-cart-queue",JSON.stringify(Array.from(this.queue))),this.runQueue();const r=await this.waitForResponse(n);return s?{cart:await this.notifyListeners(t),response:await r.json()}:{cart:await this.get(!s),response:await r.json()}}};d(l,"instance");let u=l;return window.weNexusCartApi=new u(fetch),c.CartApi=u,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}),c}({});
